<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8"> 
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Roman Sinayev" />
        <meta name="copyright" content="Roman Sinayev" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="HMM, CRF, malware, ML, " />

<meta property="og:title" content="Using Machine Learning to Name Malware "/>
<meta property="og:url" content="http://lqdc.github.io/using-machine-learning-to-name-malware.html" />
<meta property="og:description" content="Currently, there is no agreed-upon malware naming convention among AV companies. Although this is not for the lack of trying as there are multiple &#34;standards&#34;, ranging from Caro to Microsoft. When you find some malware in the wild, sometimes you want to find the procedure to remove that malware or ..." />
<meta property="og:site_name" content="lqdc blog" />
<meta property="og:article:author" content="Roman Sinayev" />
<meta property="og:article:published_time" content="2015-03-08T03:03:00-07:00" />
<meta name="twitter:title" content="Using Machine Learning to Name Malware ">
<meta name="twitter:description" content="Currently, there is no agreed-upon malware naming convention among AV companies. Although this is not for the lack of trying as there are multiple &#34;standards&#34;, ranging from Caro to Microsoft. When you find some malware in the wild, sometimes you want to find the procedure to remove that malware or ...">

        <title>Using Machine Learning to Name Malware  · lqdc blog
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="http://lqdc.github.io/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://lqdc.github.io/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://lqdc.github.io/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="http://lqdc.github.io/theme/css/custom.css" media="screen">
        <link href="http://lqdc.github.io/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="lqdc blog - Full Atom Feed" />
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
     (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
     m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
     })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-60488389-1', 'auto');
    ga('send', 'pageview');
</script>
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="http://lqdc.github.io/"><span class=site-name>lqdc blog</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="http://lqdc.github.io">Home</a></li>
                            <li ><a href="http://lqdc.github.io/categories.html">Categories</a></li>
                            <li ><a href="http://lqdc.github.io/tags.html">Tags</a></li>
                            <li ><a href="http://lqdc.github.io/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="http://lqdc.github.io/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="http://lqdc.github.io/using-machine-learning-to-name-malware.html"> Using Machine Learning to Name Malware  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <p>Currently, there is no agreed-upon malware naming convention among AV companies. Although this is not for the lack of trying as there are multiple "standards", ranging from <a href="http://www.caro.org/naming/scheme.html">Caro</a> to <a href="http://www.microsoft.com/security/portal/mmpc/shared/malwarenaming.aspx">Microsoft</a>.</p>
<p><img alt="XKCD Standards" src="http://imgs.xkcd.com/comics/standards.png" /></p>
<p>When you find some malware in the wild, sometimes you want to find the procedure to remove that malware or at least, 
given it is some known malware, figure out what properties it has.</p>
<p>Let's do an example:
Here is a <a href="https://www.virustotal.com/en/file/33d781c7ca3745870451d8a3d2ade10689005dc9f6070cc78e5ad594bdb54936/analysis/">random malware</a> found on Virustotal.
Different AVs give it different names and a person unfamiliar with typical nomenclature may not know what any of them mean.  Also, most AVs don't agree on a naming
convention, which makes interpreting the results difficult.  Moreover, we are not sure which results are correct and what they correspond to.</p>
<p>Running the sample through <a href="https://github.com/guelfoweb/peframe">peframe</a> we get a little more information:</p>
<div class="highlight"><pre>Short information
------------------------------------------------------------
File Name          33d781c7ca3745870451d8a3d2ade10689005dc9f6070cc78e5ad594bdb54936
File Size          5632 byte
Compile Time       2007-12-25 08:15:18
DLL                No
Sections           1
Hash MD5           61c9ddb015db820cbdb8a2f39548b7a1
Hash SAH1          3a5a79982e72fe2210a0722b0cea3d35520c2441
Imphash            87bed5a7cba00c7e1f4015f1bdae2183
Packer             Yes
Anti Debug         No
Anti VM            No
Directory          Import

Packer matched [1]
------------------------------------------------------------
Packer             kkrunchy 0.23 alpha 2 -&gt; Ryd

Suspicious API discovered [2]
------------------------------------------------------------
Function           GetProcAddress
Function           LoadLibraryA

File name discovered [1]
------------------------------------------------------------
Library            KERNEL32.DLL
</pre></div>


<p>So "krunchy" is a packer that obfuscates the code.</p>
<p>And after running it through the <a href="http://www.cuckoosandbox.org/">Cuckoo Sandbox</a> we see that this malware seems to modify the hosts file:</p>
<p><img alt="Malware hosts file" src="http://lqdc.github.io/images/malware_qhosts.jpg" /></p>
<p>So both Qhost and Krunchy are relatively correct names for the "family" of the malware, although Qhost is probably better.</p>
<p>We are not going to try to come up with a new standard, but instead settle on a decent name for the malware.  One way to do that is to use the names given by the AV vendors.</p>
<h2>Using Tf-idf</h2>
<p>The various naming conventions can include a lot of information such as unique id and the platform it runs on or the language it uses.  This is not particularly useful because it reaveals little information about what the malware does and how to get rid of it. Additionally, the platform/language can be inferred using filemagic, while a unique identifier might as well be a fuzzy hash of the file.</p>
<p>So how do we extract the family name?
We could use a simple statistical strategy called Term Frequency x Inverse Document Frequency or <a href="http://en.wikipedia.org/wiki/Tf%E2%80%93idf">tf-idf</a>. It works by counting the number of times each word occurs in a document and multiplying it by the log of number of documents over number of documents that have that word. That is,</p>
<div class="math">$$
\begin{align}
\mathrm{tf}_t  &amp;= \sum_{t \in d}{1}\\
\mathrm{idf}_t &amp;= \log \frac{N}{\lvert \{ d \in D : t \in d \} \rvert}
\end{align}
$$</div>
<p>
Here, <span class="math">\(t\)</span> is the term, <span class="math">\(d\)</span> is one document, <span class="math">\(D\)</span> is all documents, <span class="math">\(N\)</span> is the number of documents.</p>
<p>First we scan a bunch of malware on VT, make a file called "50kresults.json" with 50k antivirus results in the following format:</p>
<div class="highlight"><pre><span class="p">[{</span><span class="s">&quot;AV1&quot;</span><span class="p">:</span> <span class="s">&quot;Win32.Malware.name&quot;</span><span class="p">,</span> <span class="s">&quot;AV2&quot;</span><span class="p">:</span> <span class="s">&quot;Trojan.horse&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s">&quot;AV1&quot;</span><span class="p">:</span> <span class="s">&quot;Win32.BadVirus&quot;</span><span class="p">,</span> <span class="s">&quot;AV2&quot;</span><span class="p">:</span> <span class="s">&quot;JS.Iframe&quot;</span><span class="p">}]</span>
</pre></div>


<p>To figure out the family based on tf-idf we can do the following:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">from</span> <span class="nn">sklearn.feature_extraction.text</span> <span class="k">import</span> <span class="n">TfidfVectorizer</span>

<span class="k">def</span> <span class="nf">get_list_of_token_lists</span><span class="p">(</span><span class="n">list_of_dicts</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert [{&quot;AV&quot;: &quot;Some.Malware&quot;}, {&quot;AV&quot;:&quot;Another.Malware&quot;}] =&gt; [[&quot;Some&quot;, &quot;Malware&quot;], [&quot;Another&quot;, &quot;Malware&quot;]]&quot;&quot;&quot;</span>
    <span class="n">big_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_dict</span> <span class="ow">in</span> <span class="n">list_of_dicts</span><span class="p">:</span>
        <span class="n">inner_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">_dict</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="k">None</span><span class="p">:</span>
                <span class="n">inner_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;\W&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span><span class="p">])</span>
        <span class="n">big_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">inner_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">big_list</span>

<span class="k">def</span> <span class="nf">make_tfidf</span><span class="p">(</span><span class="n">list_of_dicts</span><span class="p">):</span>
    <span class="n">tfidf</span> <span class="o">=</span> <span class="n">TfidfVectorizer</span><span class="p">(</span><span class="n">analyzer</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">tfidf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">get_list_of_token_lists</span><span class="p">(</span><span class="n">list_of_dicts</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">tfidf</span>

<span class="n">j</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;50kresults.json&quot;</span><span class="p">))</span>

<span class="c">#  our result for the Qhost/Krunchy malware</span>
<span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;TrendMicro&#39;</span><span class="p">:</span> <span class="s">&#39;TROJ_QHOST.GO&#39;</span><span class="p">,</span>
 <span class="s">&#39;Comodo&#39;</span><span class="p">:</span> <span class="s">&#39;TrojWare.Win32.Trojan.Inject.~INC&#39;</span><span class="p">,</span>
 <span class="s">&#39;Avast&#39;</span><span class="p">:</span> <span class="s">&#39;Win32:QHost-BMV&#39;</span><span class="p">,</span>
 <span class="s">&#39;VIPRE&#39;</span><span class="p">:</span> <span class="s">&#39;Packed.Win32.Krunchy&#39;</span><span class="p">,</span>
 <span class="s">&#39;Fortinet&#39;</span><span class="p">:</span> <span class="s">&#39;W32/Krunchy.A!tr&#39;</span><span class="p">,</span>
 <span class="s">&#39;Ikarus&#39;</span><span class="p">:</span> <span class="s">&#39;Packer.Krunchy.B&#39;</span><span class="p">,</span>
 <span class="s">&#39;AhnLab-V3&#39;</span><span class="p">:</span> <span class="s">&#39;Win-Trojan/Krunchy.91147&#39;</span><span class="p">,</span>
 <span class="s">&#39;F-Secure&#39;</span><span class="p">:</span> <span class="s">&#39;DeepScan:Generic.Malware.Qw.CEE83C79&#39;</span><span class="p">,</span>
 <span class="s">&#39;VBA32&#39;</span><span class="p">:</span> <span class="s">&#39;suspected&#39;</span><span class="p">,</span>
 <span class="s">&#39;DrWeb&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.DownLoader.31981&#39;</span><span class="p">,</span>
 <span class="s">&#39;Jiangmin&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan/Qhost.adx&#39;</span><span class="p">,</span>
 <span class="s">&#39;Panda&#39;</span><span class="p">:</span> <span class="s">&#39;Trj/CI.A&#39;</span><span class="p">,</span>
 <span class="s">&#39;BitDefender&#39;</span><span class="p">:</span> <span class="s">&#39;DeepScan:Generic.Malware.Qw.CEE83C79&#39;</span><span class="p">,</span>
 <span class="s">&#39;GData&#39;</span><span class="p">:</span> <span class="s">&#39;DeepScan:Generic.Malware.Qw.CEE83C79&#39;</span><span class="p">,</span>
 <span class="s">&#39;Kaspersky&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.Win32.Qhost.aed&#39;</span><span class="p">,</span>
 <span class="s">&#39;nProtect&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan/W32.Qhost.5632&#39;</span><span class="p">,</span>
 <span class="s">&#39;Norman&#39;</span><span class="p">:</span> <span class="s">&#39;W32/Packed_Krunchy.A&#39;</span><span class="p">,</span>
 <span class="s">&#39;McAfee&#39;</span><span class="p">:</span> <span class="s">&#39;Generic&#39;</span><span class="p">,</span>
 <span class="s">&#39;Symantec&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.SpamThru&#39;</span><span class="p">,</span>
 <span class="s">&#39;K7AntiVirus&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan&#39;</span><span class="p">,</span>
 <span class="s">&#39;Sophos&#39;</span><span class="p">:</span> <span class="s">&#39;Mal/Generic-L&#39;</span><span class="p">,</span>
 <span class="s">&#39;TrendMicro-HouseCall&#39;</span><span class="p">:</span> <span class="s">&#39;TROJ_QHOST.GO&#39;</span><span class="p">,</span>
 <span class="s">&#39;Antiy-AVL&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan/Win32.Qhost.gen&#39;</span><span class="p">,</span>
 <span class="s">&#39;PCTools&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.SpamThru&#39;</span><span class="p">,</span>
 <span class="s">&#39;AVG&#39;</span><span class="p">:</span> <span class="s">&#39;Obfustat.ADPJ&#39;</span><span class="p">,</span>
 <span class="s">&#39;ViRobot&#39;</span><span class="p">:</span> <span class="s">&#39;Spyware.Delf.Do.5632.A&#39;</span><span class="p">,</span>
 <span class="s">&#39;Avast5&#39;</span><span class="p">:</span> <span class="s">&#39;Win32:QHost-BMV&#39;</span><span class="p">,</span>
 <span class="s">&#39;Microsoft&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan:Win32/Meredrop&#39;</span><span class="p">,</span>
 <span class="s">&#39;CAT-QuickHeal&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.Qhost.aed&#39;</span><span class="p">,</span>
 <span class="s">&#39;NOD32&#39;</span><span class="p">:</span> <span class="s">&#39;probably&#39;</span><span class="p">,</span>
 <span class="s">&#39;McAfee-GW-Edition&#39;</span><span class="p">:</span> <span class="s">&#39;Heuristic.LooksLike.Win32.Suspicious.F!83&#39;</span><span class="p">,</span>
 <span class="s">&#39;VirusBuster&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.Qhost.GQ&#39;</span><span class="p">,</span>
 <span class="s">&#39;Emsisoft&#39;</span><span class="p">:</span> <span class="s">&#39;Packer.Krunchy.B!IK&#39;</span><span class="p">,</span>
 <span class="s">&#39;AntiVir&#39;</span><span class="p">:</span> <span class="s">&#39;TR/Crypt.XPACK.Gen&#39;</span><span class="p">,</span>
 <span class="s">&#39;Commtouch&#39;</span><span class="p">:</span> <span class="s">&#39;W32/Trojan2.THU&#39;</span><span class="p">,</span>
 <span class="s">&#39;F-Prot&#39;</span><span class="p">:</span> <span class="s">&#39;W32/Trojan2.THU&#39;</span><span class="p">}</span>

<span class="n">j</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="n">tfidf</span> <span class="o">=</span> <span class="n">make_tfidf</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
<span class="n">to_guess</span> <span class="o">=</span> <span class="n">d</span>

<span class="nb">print</span><span class="p">(</span><span class="s">&quot;We have to guess the family name in the following result:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">to_guess</span><span class="p">)</span>

<span class="n">l_of_l</span> <span class="o">=</span> <span class="n">get_list_of_token_lists</span><span class="p">([</span><span class="n">to_guess</span><span class="p">])</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">tfidf</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">l_of_l</span><span class="p">)</span>
<span class="n">els_to_pos</span> <span class="o">=</span> <span class="p">{</span><span class="n">e</span><span class="p">:</span> <span class="n">tfidf</span><span class="o">.</span><span class="n">vocabulary_</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">l_of_l</span><span class="p">[</span><span class="mi">0</span><span class="p">]}</span>
<span class="n">els_to_scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">m</span><span class="p">[:,</span> <span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">toarray</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">els_to_pos</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="nb">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Top 3 results for families:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([(</span><span class="n">token</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">score</span><span class="p">)</span> <span class="ow">in</span> <span class="n">els_to_scores</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">token</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="k">True</span><span class="p">)[:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>


<p>And we get the following output:</p>
<div class="highlight"><pre>Top 3 results for families:
[(&#39;Krunchy&#39;, 0.45202206291544067), (&#39;Qhost&#39;, 0.38232102610232943), (&#39;CEE83C79&#39;, 0.28923118570941675)]
</pre></div>


<p>So this worked pretty well.  </p>
<p>However, this strategy does not always work. For example, for the following set of results:</p>
<div class="highlight"><pre><span class="p">{</span><span class="s">&#39;Comodo&#39;</span><span class="p">:</span> <span class="s">&#39;UnclassifiedMalware&#39;</span><span class="p">,</span>
 <span class="s">&#39;Avast&#39;</span><span class="p">:</span> <span class="s">&#39;Win32:Dropper-gen&#39;</span><span class="p">,</span>
 <span class="s">&#39;VIPRE&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.Win32.Generic!BT&#39;</span><span class="p">,</span>
 <span class="s">&#39;Fortinet&#39;</span><span class="p">:</span> <span class="s">&#39;W32/Small.JGG!tr.dldr&#39;</span><span class="p">,</span>
 <span class="s">&#39;Agnitum&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.PWS.Nilage!7qzxMXSt8xA&#39;</span><span class="p">,</span>
 <span class="s">&#39;AhnLab-V3&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan/Win32.Downloader&#39;</span><span class="p">,</span>
 <span class="s">&#39;F-Secure&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.Generic.4486012&#39;</span><span class="p">,</span>
 <span class="s">&#39;DrWeb&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.DownLoader1.14982&#39;</span><span class="p">,</span>
 <span class="s">&#39;Jiangmin&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan/PSW.Nilage.eeb&#39;</span><span class="p">,</span>
 <span class="s">&#39;Panda&#39;</span><span class="p">:</span> <span class="s">&#39;Trj/CI.A&#39;</span><span class="p">,</span>
 <span class="s">&#39;BitDefender&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.Generic.4486012&#39;</span><span class="p">,</span>
 <span class="s">&#39;GData&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.Generic.4486012&#39;</span><span class="p">,</span>
 <span class="s">&#39;Kaspersky&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan-GameThief.Win32.Nilage.hjm&#39;</span><span class="p">,</span>
 <span class="s">&#39;nProtect&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan/W32.Small.23040.AU&#39;</span><span class="p">,</span>
 <span class="s">&#39;VBA32&#39;</span><span class="p">:</span> <span class="s">&#39;TrojanPSW.Nilage&#39;</span><span class="p">,</span>
 <span class="s">&#39;McAfee&#39;</span><span class="p">:</span> <span class="s">&#39;PWS-Lineage!l&#39;</span><span class="p">,</span>
 <span class="s">&#39;Symantec&#39;</span><span class="p">:</span> <span class="s">&#39;Spyware.Keylogger&#39;</span><span class="p">,</span>
 <span class="s">&#39;K7AntiVirus&#39;</span><span class="p">:</span> <span class="s">&#39;Riskware&#39;</span><span class="p">,</span>
 <span class="s">&#39;Antiy-AVL&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan/win32.agent.gen&#39;</span><span class="p">,</span>
 <span class="s">&#39;PCTools&#39;</span><span class="p">:</span> <span class="s">&#39;Spyware.Keylogger!rem&#39;</span><span class="p">,</span>
 <span class="s">&#39;AVG&#39;</span><span class="p">:</span> <span class="s">&#39;PSW.OnlineGames3.APII&#39;</span><span class="p">,</span>
 <span class="s">&#39;TheHacker&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan/Nilage.hjm&#39;</span><span class="p">,</span>
 <span class="s">&#39;Ikarus&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan-Downloader.Win32.Banload&#39;</span><span class="p">,</span>
 <span class="s">&#39;ESET-NOD32&#39;</span><span class="p">:</span> <span class="s">&#39;a&#39;</span><span class="p">,</span>
 <span class="s">&#39;McAfee-GW-Edition&#39;</span><span class="p">:</span> <span class="s">&#39;PWS-Lineage!l&#39;</span><span class="p">,</span>
 <span class="s">&#39;NANO-Antivirus&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.Win32.Nilage.bcufrb&#39;</span><span class="p">,</span>
 <span class="s">&#39;Emsisoft&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.Generic.4486012&#39;</span><span class="p">,</span>
 <span class="s">&#39;AntiVir&#39;</span><span class="p">:</span> <span class="s">&#39;TR/Crypt.CFI.Gen&#39;</span><span class="p">,</span>
 <span class="s">&#39;MicroWorld-eScan&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.Generic.4486012&#39;</span><span class="p">,</span>
 <span class="s">&#39;Commtouch&#39;</span><span class="p">:</span> <span class="s">&#39;W32/Risk.ZZEX-7195&#39;</span><span class="p">,</span>
 <span class="s">&#39;Norman&#39;</span><span class="p">:</span> <span class="s">&#39;Downloader&#39;</span><span class="p">,</span>
 <span class="s">&#39;K7GW&#39;</span><span class="p">:</span> <span class="s">&#39;Password-Stealer&#39;</span><span class="p">,</span>
 <span class="s">&#39;F-Prot&#39;</span><span class="p">:</span> <span class="s">&#39;W32/MalwareF.IIVH&#39;</span><span class="p">}</span>
</pre></div>


<p>The process yields:</p>
<div class="highlight"><pre>Top 3 results for families:
[(&#39;4486012&#39;, 0.53745997540319712), (&#39;Nilage&#39;, 0.53215845680514295), (&#39;Trojan&#39;, 0.18195861475064623)]
</pre></div>


<p>Where Trojan and the 4486012 number result are not what we are interested in.</p>
<h2>Using CRF</h2>
<p>So how do we figure out which
If we re-frame the problem of figuring out a good name into the problem of labeling  parts of virus names and then combining the labels from different antiviruses, we can see it as a <a href="http://en.wikipedia.org/wiki/Text_segmentation">text segmentation</a> problem. </p>
<p>In our case, text segmentation can be used to infer what each part of a virus name means. That is, </p>
<div class="highlight"><pre><span class="s">&quot;Win32.MalwareFamily.uniqueid&quot;</span>
</pre></div>


<p>Can be split into</p>
<div class="highlight"><pre><span class="p">[</span><span class="s">&quot;Win32&quot;</span><span class="p">,</span> <span class="s">&quot;Agent&quot;</span><span class="p">,</span> <span class="s">&quot;1234&quot;</span><span class="p">]</span>
</pre></div>


<p>and labeled as</p>
<div class="highlight"><pre><span class="p">[</span><span class="s">&quot;Platform&quot;</span><span class="p">,</span> <span class="s">&quot;Family&quot;</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">]</span>
</pre></div>


<p>After that, based on all the platform names that we get from AVs we can figure out what the consensus is. We want to use CRFs instead of something like Naive Bayes, because the order of tokens within each AV’s name for a virus is very important and because the tokens are not independent (i.e. An Iframe family malware is probably written in Javascript).</p>
<p>There are a number of algorithms that can be used to infer what each part of the virus name means including those based on Hidden Markov Models (HMM) and Conditional Random Fields (CRF).<br />
There is already an excellent explanation of how HMMs work and how to figure out what the states are on the <a href="http://en.wikipedia.org/wiki/Viterbi_algorithm#Example">Viterbi Algorithm Wiki</a>.  </p>
<p>CRFs can be viewed as a generalization of HMMs that makes the constant transition probabilities such as from Healthy to Fever on the wiki page into arbitrary 
functions that vary across the positions in the sequence of hidden states (Health or Fever), depending on the input sequence (normal, cold or dizzy).</p>
<p>Here we will use the excellent <a href="http://www.chokkan.org/software/crfsuite">CRFSuite</a> library to label the states.
We’ll create some training data, convert it to features, train a model and run it on some results we haven’t seen before.</p>
<p>First, let’s create some training data to label parts of virus names with their corresponding tags. We would want to convert antivirus results such as</p>
<div class="highlight"><pre><span class="p">[{</span><span class="s">&quot;AntiVir&quot;</span><span class="p">:</span> <span class="s">&quot;TR/Crypt.XPACK.Gen2&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s">&quot;AntiVir&quot;</span><span class="p">:</span><span class="s">&quot;DR/Delphi.Gen&quot;</span><span class="p">}]</span>
</pre></div>


<p>into the following:</p>
<div class="highlight"><pre>TR 0 AntiVir _type
/ / AntiVir delim
Crypt 1 AntiVir family
. . AntiVir delim
XPACK 2 AntiVir group
. . AntiVir delim
Gen2 3 AntiVir ident

DR 0 AntiVir _type
/ / AntiVir delim
Delphi 1 AntiVir family
. . AntiVir delim
Gen 2 AntiVir ident
</pre></div>


<p>With the last column being the labels that will later be guessed. To create the above format, we can use the following:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="n">REGEX_NONWORD</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;\W&quot;</span><span class="p">)</span>
<span class="n">REGEX_NONWORD_SAVED</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">&quot;(\W)&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">preprocess_av_result</span><span class="p">(</span><span class="n">av_result</span><span class="p">,</span> <span class="n">av</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Split an av result into a list of maps for word, pos, av and label</span>

<span class="sd">    EG. take something like &#39;win32.malware.group&#39; and convert to</span>
<span class="sd">        [{&#39;av&#39;: &#39;someav&#39;, &#39;w&#39;: &#39;win32&#39;, &#39;pos&#39;: &#39;0&#39;, &#39;label&#39;: &#39;skip&#39;},</span>
<span class="sd">         {&#39;av&#39;: &#39;someav&#39;, &#39;w&#39;: &#39;.&#39;, &#39;pos&#39;: &#39;.&#39;, &#39;label&#39;: &#39;delim&#39;},</span>
<span class="sd">         {&#39;av&#39;: &#39;someav&#39;, &#39;w&#39;: &#39;malware&#39;, &#39;pos&#39;: &#39;1&#39;, &#39;label&#39;: &#39;skip&#39;},</span>
<span class="sd">         {&#39;av&#39;: &#39;someav&#39;, &#39;w&#39;: &#39;.&#39;, &#39;pos&#39;: &#39;.&#39;, &#39;label&#39;: &#39;delim&#39;},</span>
<span class="sd">         {&#39;av&#39;: &#39;someav&#39;, &#39;w&#39;: &#39;group&#39;, &#39;pos&#39;: &#39;2&#39;, &#39;label&#39;: &#39;skip&#39;}]</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">split_delim</span> <span class="o">=</span> <span class="p">[</span><span class="n">el</span> <span class="k">if</span> <span class="n">el</span> <span class="o">!=</span> <span class="s">&#39; &#39;</span> <span class="k">else</span> <span class="s">&#39;_&#39;</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span>
                   <span class="n">REGEX_NONWORD_SAVED</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">av_result</span><span class="p">)]</span>
    <span class="n">split_no_delim</span> <span class="o">=</span> <span class="n">REGEX_NONWORD</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">av_result</span><span class="p">)</span>
    <span class="n">delims</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">split_delim</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">split_no_delim</span><span class="p">)</span>

    <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">split_delim</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">delims</span><span class="p">:</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;delim&#39;</span><span class="p">)</span>
            <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;skip&#39;</span><span class="p">)</span> 
            <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">counter</span><span class="p">))</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="p">[{</span><span class="s">&#39;w&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span> <span class="s">&#39;pos&#39;</span><span class="p">:</span> <span class="n">j</span><span class="p">,</span> <span class="s">&#39;av&#39;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span> <span class="s">&#39;label&#39;</span><span class="p">:</span> <span class="n">l</span><span class="p">}</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span>
            <span class="nb">zip</span><span class="p">(</span><span class="n">split_delim</span><span class="p">,</span> <span class="n">tags</span><span class="p">,</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">av</span><span class="p">),</span> <span class="n">labels</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">]</span>


<span class="n">j</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;50kresults.json&quot;</span><span class="p">))[:</span><span class="mi">1000</span><span class="p">]</span>  <span class="c"># contains the results</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;all_train.txt&quot;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c"># name of the training file</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">av</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">res</span> <span class="ow">is</span> <span class="k">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">preprocess_av_result</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">av</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\t</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">fd</span><span class="p">[</span><span class="s">&#39;w&#39;</span><span class="p">],</span> <span class="n">fd</span><span class="p">[</span><span class="s">&#39;pos&#39;</span><span class="p">],</span> <span class="n">fd</span><span class="p">[</span><span class="s">&#39;av&#39;</span><span class="p">],</span> <span class="n">fd</span><span class="p">[</span><span class="s">&#39;label&#39;</span><span class="p">]])</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
</pre></div>


<p>After creating and manually labeling the tokens (we label the last column in “all_train.txt” according to what we think the token actually corresponds to), we want to create a feature file that crfsuite understands. To convert the result to features, we can use the slightly modified script built into crfsuite called ‘chunking.py’ that converts labeled CSV file to feature file. All we have to do to take advantage of the fact that CRF can use the fact that each antivirus uses a slightly different naming convention is to modify the template (included below).</p>
<div class="highlight"><pre><span class="n">templates</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">((</span><span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="p">),</span>
    <span class="p">((</span><span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">),</span>
    <span class="p">((</span><span class="s">&#39;w&#39;</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span> <span class="p">),</span>
    <span class="p">((</span><span class="s">&#39;w&#39;</span><span class="p">,</span>  <span class="mi">1</span><span class="p">),</span> <span class="p">),</span>
    <span class="p">((</span><span class="s">&#39;w&#39;</span><span class="p">,</span>  <span class="mi">2</span><span class="p">),</span> <span class="p">),</span>
    <span class="p">((</span><span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;w&#39;</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)),</span>
    <span class="p">((</span><span class="s">&#39;w&#39;</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;w&#39;</span><span class="p">,</span>  <span class="mi">1</span><span class="p">)),</span>
    <span class="p">((</span><span class="s">&#39;pos&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="p">),</span>
    <span class="p">((</span><span class="s">&#39;pos&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">),</span>
    <span class="p">((</span><span class="s">&#39;pos&#39;</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span> <span class="p">),</span>
    <span class="p">((</span><span class="s">&#39;pos&#39;</span><span class="p">,</span>  <span class="mi">1</span><span class="p">),</span> <span class="p">),</span>
    <span class="p">((</span><span class="s">&#39;pos&#39;</span><span class="p">,</span>  <span class="mi">2</span><span class="p">),</span> <span class="p">),</span>
    <span class="p">((</span><span class="s">&#39;pos&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;pos&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
    <span class="p">((</span><span class="s">&#39;pos&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;pos&#39;</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)),</span>
    <span class="p">((</span><span class="s">&#39;pos&#39;</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;pos&#39;</span><span class="p">,</span>  <span class="mi">1</span><span class="p">)),</span>
    <span class="p">((</span><span class="s">&#39;pos&#39;</span><span class="p">,</span>  <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;pos&#39;</span><span class="p">,</span>  <span class="mi">2</span><span class="p">)),</span>
    <span class="p">((</span><span class="s">&#39;pos&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;pos&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;pos&#39;</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)),</span>
    <span class="p">((</span><span class="s">&#39;pos&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;pos&#39;</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;pos&#39;</span><span class="p">,</span>  <span class="mi">1</span><span class="p">)),</span>
    <span class="p">((</span><span class="s">&#39;pos&#39;</span><span class="p">,</span>  <span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;pos&#39;</span><span class="p">,</span>  <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;pos&#39;</span><span class="p">,</span>  <span class="mi">2</span><span class="p">)),</span>
    <span class="p">((</span><span class="s">&#39;av&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="p">),</span>
    <span class="p">)</span>
</pre></div>


<p>We save it to chunking_av.py and run it with the following command:</p>
<div class="highlight"><pre>cat all_train.txt | ./chunking_av.py &gt; all_train.crfsuit.txt
</pre></div>


<p>After that, we have to train the model using the features file:</p>
<div class="highlight"><pre>crfsuite learn -m all_train.model all_train.crfsuit.txt
</pre></div>


<p>After that, we can check how the model performs with some testing data:</p>
<div class="highlight"><pre>cat all_test.txt | ./chunking_av.py &gt; all_test.crfsuite.txt
crfsuite tag -m all_train.model -t all_test.crfsuite.txt
</pre></div>


<p>Annnnd….</p>
<div class="highlight"><pre>Performance by label (#match, #model, #ref) (precision, recall, F1):
    _type: (80, 80, 80) (1.0000, 1.0000, 1.0000)
    delim: (558, 558, 558) (1.0000, 1.0000, 1.0000)
    family: (159, 162, 159) (0.9815, 1.0000, 0.9907)
    group: (19, 19, 19) (1.0000, 1.0000, 1.0000)
    ident: (152, 152, 156) (1.0000, 0.9744, 0.9870)
    skip: (95, 97, 95) (0.9794, 1.0000, 0.9896)
    platform: (109, 109, 112) (1.0000, 0.9732, 0.9864)
    language: (12, 15, 13) (0.8000, 0.9231, 0.8571)
    method: (7, 7, 7) (1.0000, 1.0000, 1.0000)
    compiler: (0, 0, 0) (******, ******, ******)
    _test: (0, 0, 0) (******, ******, ******)
    malic: (27, 27, 27) (1.0000, 1.0000, 1.0000)

Macro-average precision, recall, F1: (0.697204, 0.705046, 0.700773)
Item accuracy: 1218 / 1226 (0.9935)
Instance accuracy: 152 / 160 (0.9500)
</pre></div>


<p>We are primarily interested in the family accuracy which is at ~98%. Good enough.</p>
<p>Now we can use the “all_train.model” file to tag tokens in new malware names.
First, create a function for extracting features from labeled text:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">extract_features</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="n">all_features</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
        <span class="n">el_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;label&#39;</span><span class="p">]]</span>
        <span class="k">for</span> <span class="n">template</span> <span class="ow">in</span> <span class="n">templates</span><span class="p">:</span>
            <span class="n">features_i</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&#39;%s[%d]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">template</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">offset</span> <span class="ow">in</span> <span class="n">template</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="n">offset</span>
                <span class="k">if</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
                    <span class="n">features_i</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">break</span>
                <span class="n">features_i</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">field</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">features_i</span><span class="p">:</span>
                <span class="n">el_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;%s=%s&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">features_i</span><span class="p">)))</span>
        <span class="n">all_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">el_features</span><span class="p">)</span>
    <span class="n">all_features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;__BOS__&#39;</span><span class="p">)</span>
    <span class="n">all_features</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;__EOS__&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">all_features</span>
</pre></div>


<p>Then use the Tagger class from python-crfsuite library to label the malware:</p>
<div class="highlight"><pre><span class="kn">from</span> <span class="nn">pycrfsuite</span> <span class="k">import</span> <span class="n">Tagger</span>
<span class="n">tagger</span> <span class="o">=</span> <span class="n">Tagger</span><span class="p">()</span>
<span class="n">tagger</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;all_train.model&quot;</span><span class="p">)</span>  <span class="c"># our model file we created in previous step.</span>
<span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="s">&#39;F-Prot&#39;</span><span class="p">,</span> <span class="s">&#39;W32/LoadMoney.K.gen!Eldorado&#39;</span>  <span class="c"># av result from previous section</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">tagger</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="n">extract_features</span><span class="p">(</span><span class="n">preprocess_av_result</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s">&quot;Antivirus:&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s">&quot;Antivirus result:&quot;</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s">&quot;Tokenized result:&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s">&#39;w&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">preprocess_av_result</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)])</span>
<span class="nb">print</span><span class="p">(</span><span class="s">&quot;Labeled result&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
</pre></div>


<p>We get the following output:</p>
<div class="highlight"><pre>Antivirus: F-Prot
Antivirus result: W32/LoadMoney.K.gen!Eldorado
Tokenized result: [&#39;W32&#39;, &#39;/&#39;, &#39;LoadMoney&#39;, &#39;.&#39;, &#39;K&#39;, &#39;.&#39;, &#39;gen&#39;, &#39;!&#39;, &#39;Eldorado&#39;]
Labeled result [&#39;platform&#39;, &#39;delim&#39;, &#39;family&#39;, &#39;delim&#39;, &#39;ident&#39;, &#39;delim&#39;, &#39;skip&#39;, &#39;delim&#39;, &#39;ident&#39;]
</pre></div>


<p>It worked! We now know what each token corresponds to. We can further improve results by modifying the template, including additional features, do further post-processing such as picking one name among synonymous names, grouping similarly spelled labels, etc.</p>
<p>But this seems to be good enough for now.</p>
<p>Once we have all the post-processing in place, we can even guess the labels of the malware we could't get with Tf-idf:</p>
<div class="highlight"><pre><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span> <span class="nn">name_generator</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">g</span> <span class="o">=</span> <span class="n">name_generator</span><span class="o">.</span><span class="n">Guesser</span><span class="p">()</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;Comodo&#39;</span><span class="p">:</span> <span class="s">&#39;UnclassifiedMalware&#39;</span><span class="p">,</span>
             <span class="s">&#39;Avast&#39;</span><span class="p">:</span> <span class="s">&#39;Win32:Dropper-gen&#39;</span><span class="p">,</span>
             <span class="s">&#39;VIPRE&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.Win32.Generic!BT&#39;</span><span class="p">,</span>
             <span class="s">&#39;Fortinet&#39;</span><span class="p">:</span> <span class="s">&#39;W32/Small.JGG!tr.dldr&#39;</span><span class="p">,</span>
             <span class="s">&#39;Agnitum&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.PWS.Nilage!7qzxMXSt8xA&#39;</span><span class="p">,</span>
             <span class="s">&#39;AhnLab-V3&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan/Win32.Downloader&#39;</span><span class="p">,</span>
             <span class="s">&#39;F-Secure&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.Generic.4486012&#39;</span><span class="p">,</span>
             <span class="s">&#39;DrWeb&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.DownLoader1.14982&#39;</span><span class="p">,</span>
             <span class="s">&#39;Jiangmin&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan/PSW.Nilage.eeb&#39;</span><span class="p">,</span>
             <span class="s">&#39;Panda&#39;</span><span class="p">:</span> <span class="s">&#39;Trj/CI.A&#39;</span><span class="p">,</span>
             <span class="s">&#39;BitDefender&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.Generic.4486012&#39;</span><span class="p">,</span>
             <span class="s">&#39;GData&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.Generic.4486012&#39;</span><span class="p">,</span>
             <span class="s">&#39;Kaspersky&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan-GameThief.Win32.Nilage.hjm&#39;</span><span class="p">,</span>
             <span class="s">&#39;nProtect&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan/W32.Small.23040.AU&#39;</span><span class="p">,</span>
             <span class="s">&#39;VBA32&#39;</span><span class="p">:</span> <span class="s">&#39;TrojanPSW.Nilage&#39;</span><span class="p">,</span>
             <span class="s">&#39;McAfee&#39;</span><span class="p">:</span> <span class="s">&#39;PWS-Lineage!l&#39;</span><span class="p">,</span>
             <span class="s">&#39;Symantec&#39;</span><span class="p">:</span> <span class="s">&#39;Spyware.Keylogger&#39;</span><span class="p">,</span>
             <span class="s">&#39;K7AntiVirus&#39;</span><span class="p">:</span> <span class="s">&#39;Riskware&#39;</span><span class="p">,</span>
             <span class="s">&#39;Antiy-AVL&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan/win32.agent.gen&#39;</span><span class="p">,</span>
             <span class="s">&#39;PCTools&#39;</span><span class="p">:</span> <span class="s">&#39;Spyware.Keylogger!rem&#39;</span><span class="p">,</span>
             <span class="s">&#39;AVG&#39;</span><span class="p">:</span> <span class="s">&#39;PSW.OnlineGames3.APII&#39;</span><span class="p">,</span>
             <span class="s">&#39;TheHacker&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan/Nilage.hjm&#39;</span><span class="p">,</span>
             <span class="s">&#39;Ikarus&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan-Downloader.Win32.Banload&#39;</span><span class="p">,</span>
             <span class="s">&#39;ESET-NOD32&#39;</span><span class="p">:</span> <span class="s">&#39;a&#39;</span><span class="p">,</span>
             <span class="s">&#39;McAfee-GW-Edition&#39;</span><span class="p">:</span> <span class="s">&#39;PWS-Lineage!l&#39;</span><span class="p">,</span>
             <span class="s">&#39;NANO-Antivirus&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.Win32.Nilage.bcufrb&#39;</span><span class="p">,</span>
             <span class="s">&#39;Emsisoft&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.Generic.4486012&#39;</span><span class="p">,</span>
             <span class="s">&#39;AntiVir&#39;</span><span class="p">:</span> <span class="s">&#39;TR/Crypt.CFI.Gen&#39;</span><span class="p">,</span>
             <span class="s">&#39;MicroWorld-eScan&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan.Generic.4486012&#39;</span><span class="p">,</span>
             <span class="s">&#39;Commtouch&#39;</span><span class="p">:</span> <span class="s">&#39;W32/Risk.ZZEX-7195&#39;</span><span class="p">,</span>
             <span class="s">&#39;Norman&#39;</span><span class="p">:</span> <span class="s">&#39;Downloader&#39;</span><span class="p">,</span>
             <span class="s">&#39;K7GW&#39;</span><span class="p">:</span> <span class="s">&#39;Password-Stealer&#39;</span><span class="p">,</span>
             <span class="s">&#39;F-Prot&#39;</span><span class="p">:</span> <span class="s">&#39;W32/MalwareF.IIVH&#39;</span><span class="p">}</span>
<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">g</span><span class="o">.</span><span class="n">guess_everything</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">4</span><span class="p">]:</span>
<span class="p">{</span><span class="s">&#39;family&#39;</span><span class="p">:</span> <span class="s">&#39;Nilage&#39;</span><span class="p">,</span>
 <span class="s">&#39;platform&#39;</span><span class="p">:</span> <span class="s">&#39;Win32&#39;</span><span class="p">,</span>
 <span class="s">&#39;group&#39;</span><span class="p">:</span> <span class="s">&#39;unknown&#39;</span><span class="p">,</span>
 <span class="s">&#39;ident&#39;</span><span class="p">:</span> <span class="s">&#39;hjm&#39;</span><span class="p">,</span>
 <span class="s">&#39;language&#39;</span><span class="p">:</span> <span class="s">&#39;unknown&#39;</span><span class="p">,</span>
 <span class="s">&#39;compiler&#39;</span><span class="p">:</span> <span class="s">&#39;unknown&#39;</span><span class="p">,</span>
 <span class="s">&#39;_type&#39;</span><span class="p">:</span> <span class="s">&#39;Trojan&#39;</span><span class="p">}</span>
</pre></div>


<p>All of the post-processing to settle on one common name has already been done and you can find the library that can guess the virus names at this <a href="https://github.com/lqdc/virus-names">github repo</a>.</p>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }
    
    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = '//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); ";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
            
            <section>
<div class="accordion" id="accordion2">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle disqus-comment-count" data-toggle="collapse" data-parent="#accordion2"
                href="http://lqdc.github.io/using-machine-learning-to-name-malware.html#disqus_thread">
                Comments
            </a>
        </div>
        <div id="disqus_thread" class="accordion-body collapse">
            <div class="accordion-inner">
                <div class="comments">
                    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'codellama';
        var disqus_identifier = 'http://lqdc.github.io/using-machine-learning-to-name-malware.html';
    var disqus_url = 'http://lqdc.github.io/using-machine-learning-to-name-malware.html';

    (function() {
         var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
         dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
         (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

                </div>
            </div>
        </div>
    </div>
</div>
</section>

            <hr/>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2015-03-08T03:03:00-07:00">Mar 8, 2015</time>
            <h4>Category</h4>
            <a class="category-link" href="http://lqdc.github.io/categories.html#ml-ref">ML</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="http://lqdc.github.io/tags.html#crf-ref">CRF
                    <span>1</span>
</a></li>
                <li><a href="http://lqdc.github.io/tags.html#hmm-ref">HMM
                    <span>1</span>
</a></li>
                <li><a href="http://lqdc.github.io/tags.html#malware-ref">malware
                    <span>1</span>
</a></li>
            </ul>
<h4>Contact</h4>
    <a href="http://github.com/lqdc" title="My github Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-github sidebar-social-links"></i></a>
    <a href="http://rsinayev.com" title="My home Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-home sidebar-social-links"></i></a>
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="http://code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

            <script type="text/javascript">
var disqus_shortname = 'codellama';
(function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
}());
</script>
<script  language="javascript" type="text/javascript">
function uncollapse() {
    if (window.location.hash.match(/^#comment-\d+$/)) {
        $('#disqus_thread').collapse('show');
    }
}
</script>
<script type="text/javascript" language="JavaScript">
uncollapse();
window.onhashchange=function(){
    if (window.location.hash.match(/^#comment-\d+$/))
        window.location.reload(true);
}
</script>
<script>
$('#disqus_thread').on('shown', function () {
    var link = document.getElementsByClassName('accordion-toggle');
    var old_innerHTML = link[0].innerHTML;
    $(link[0]).fadeOut(500, function() {
        $(this).text('Click here to hide comments').fadeIn(500);
    });
    $('#disqus_thread').on('hidden', function () {
        $(link[0]).fadeOut(500, function() {
            $(this).text(old_innerHTML).fadeIn(500);
        });
    })
})
</script>


    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>