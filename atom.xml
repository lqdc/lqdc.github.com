<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Code Llama]]></title>
  <link href="http://lqdc.github.com/atom.xml" rel="self"/>
  <link href="http://lqdc.github.com/"/>
  <updated>2013-04-07T09:51:37-04:00</updated>
  <id>http://lqdc.github.com/</id>
  <author>
    <name><![CDATA[Roman Sinayev]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Compiling NumPy and SciPy with Intel MKL]]></title>
    <link href="http://lqdc.github.com/blog/2013/04/07/compiling-numpy-and-scipy-with-intel-mkl/"/>
    <updated>2013-04-07T07:09:00-04:00</updated>
    <id>http://lqdc.github.com/blog/2013/04/07/compiling-numpy-and-scipy-with-intel-mkl</id>
    <content type="html"><![CDATA[<p>If you have an Intel processor, you can take advantage of the Intel MKL, which contains performance optimizations for math routines.  Although it works with AMD processors too, Atlas seems to be a better choice there.</p>

<p>Intel provides their own guide <a href="http://software.intel.com/en-us/articles/numpyscipy-with-intel-mkl">here</a>, however they skip on some details.</p>

<p>Below is how I compiled and tested numpy-1.8, scipy-0.13, and Intel MKL-11.0 on Ubuntu 12.10.</p>

<p><strong>1. See how fast your current numpy is:</strong></p>

<figure class='code'><figcaption><span>NumPy 1.8 Random Dot Product  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
</span><span class='line'><span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
</span><span class='line'><span class="o">%</span><span class="n">timeit</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I get the following on an i5-3570k machine:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>10 loops, best of 3: 68.7 ms per loop</span></code></pre></td></tr></table></div></figure>


<p>You can also check the default config <code>numpy.show_config()</code>.  On Ubuntu, the default is the following:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>blas_info:
</span><span class='line'>        libraries = ['blas']
</span><span class='line'>        library_dirs = ['/usr/lib']
</span><span class='line'>        language = f77
</span><span class='line'>    lapack_info:
</span><span class='line'>        libraries = ['lapack']
</span><span class='line'>        library_dirs = ['/usr/lib']
</span><span class='line'>        language = f77
</span><span class='line'>    atlas_threads_info:
</span><span class='line'>      NOT AVAILABLE
</span><span class='line'>    blas_opt_info:
</span><span class='line'>        libraries = ['blas']
</span><span class='line'>        library_dirs = ['/usr/lib']
</span><span class='line'>        language = f77
</span><span class='line'>        define_macros = [('NO_ATLAS_INFO', 1)]
</span><span class='line'>    atlas_blas_threads_info:
</span><span class='line'>      NOT AVAILABLE
</span><span class='line'>    lapack_opt_info:
</span><span class='line'>        libraries = ['lapack', 'blas']
</span><span class='line'>        library_dirs = ['/usr/lib']
</span><span class='line'>        language = f77
</span><span class='line'>        define_macros = [('NO_ATLAS_INFO', 1)]
</span><span class='line'>    atlas_info:
</span><span class='line'>      NOT AVAILABLE
</span><span class='line'>    lapack_mkl_info:
</span><span class='line'>      NOT AVAILABLE
</span><span class='line'>    blas_mkl_info:
</span><span class='line'>      NOT AVAILABLE
</span><span class='line'>    atlas_blas_info:
</span><span class='line'>      NOT AVAILABLE
</span><span class='line'>    mkl_info:
</span><span class='line'>      NOT AVAILABLE</span></code></pre></td></tr></table></div></figure>


<p><strong>2. Get the software:</strong></p>

<p>Intel Compilers and MKL:</p>

<p>Intel only provides MKL for free for Non-Commercial purposes.
Get it from their site along with the compiler and a bunch of other useful stuff. I got the Intel Parallel Studio that includes the necessary icc and ifort compilers from <a href="http://software.intel.com/en-us/non-commercial-software-development">here</a>.</p>

<p>SciPy and NumPy from Github:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone https://github.com/scipy/scipy.git
</span><span class='line'>git clone https://github.com/numpy/numpy.git</span></code></pre></td></tr></table></div></figure>


<p><strong>3. Get rid of your old numpy and scipy (optional):</strong></p>

<p>On Linux:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get remove python-numpy python-scipy
</span><span class='line'># or do via pip uninstall if it was installed with pip</span></code></pre></td></tr></table></div></figure>


<p><strong>4. Install MKL and Intel/Fortran Compilers</strong></p>

<p>Here you just download the software and run the bash script to install it.  On Linux the default installation dir is <code>/opt/intel/</code>.</p>

<p>You should also add the environmental variables to your shell.  As per Intel&#8217;s suggestion at the end of the installation, add something like the following to <code>.bashrc</code> or <code>.profile</code> or <code>.bash_profile</code>:
<code>source /opt/intel/bin/compilervars.sh intel64</code>.  This runs a number of scripts that modify your <code>$LD_LIBRARY_PATH</code> variable.
Now you should be able to call <code>icc --help</code> in a new terminal window.</p>

<p><strong>5. Prepare NumPy for compilation</strong></p>

<p>Go into the numpy directory you created and add the following to the <code>site.cfg</code> file:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[mkl]
</span><span class='line'>library_dirs = /opt/intel/mkl/composer_xe_2013/lib/intel64
</span><span class='line'>include_dirs = /opt/intel/mkl/include
</span><span class='line'>mkl_libs = mkl_rt
</span><span class='line'>lapack_libs =</span></code></pre></td></tr></table></div></figure>


<p>If you are building NumPy for 32 bit, please add as the following</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[mkl] library_dirs = /opt/intel/composer_xe_2013/mkl/lib/ia32
</span><span class='line'>include_dirs = /opt/intel/mkl/include
</span><span class='line'>mkl_libs = mkl_rt
</span><span class='line'>lapack_libs =</span></code></pre></td></tr></table></div></figure>


<p>Now modify <code>intelcompiler.py</code> in the <code>/numpy/numpy/distutils</code> directory:
There are currently three classes in the file.  You would need to modify the one that&#8217;s based on your architecture.
If you use 64 bit, modify <code>IntelEM64TCCompiler</code> class by modifying <code>self.cc_exe</code> to be something like</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="bp">self</span><span class="o">.</span><span class="n">cc_exe</span> <span class="o">=</span> <span class="s">&#39;icc -O3 -g -fPIC -fp-model strict -fomit-frame-pointer -openmp -xhost&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you use 32 bit, modify the IntelCCompiler&#8217;s <code>self.cc_exe</code> to something similar to the above.</p>

<p>The exact configuration is going to depend on your needs and computer, but you can check what all the options mean by running <code>icc --help</code>.</p>

<p>Intel also suggests to modify the fortran compiler options, but they are already set to the suggested values.  In case you want to modify them, they are in <code>numpy/numpy/distutils/fcompiler/intel.py</code>.</p>

<p><strong>6. Compile Numpy and Scipy</strong></p>

<p>Run the following in the numpy directory:</p>

<p><em>Replace <code>intelem</code> with <code>intel</code> on 32 bit machines.</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>python setup.py config --compiler=intelem build_clib --compiler=intelem build_ext --compiler=intelem install</span></code></pre></td></tr></table></div></figure>


<p>If you want to install to user home dir, add <code>--prefix=$HOME/.local</code>.</p>

<p>Run the following in the scipy directory:</p>

<p><em>Replace <code>intelem</code> with <code>intel</code> on 32 bit machines.</em></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>python setup.py config --compiler=intelem --fcompiler=intelem build_clib --compiler=intelem --fcompiler=intelem build_ext --compiler=intelem --fcompiler=intelem install</span></code></pre></td></tr></table></div></figure>


<p><strong>7. You&#8217;re done!</strong></p>

<p>Now, check the dot product again in a new terminal window:</p>

<figure class='code'><figcaption><span>Numpy 1.8 Random Dot Product  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
</span><span class='line'><span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
</span><span class='line'><span class="o">%</span><span class="n">timeit</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</span><span class='line'><span class="c"># 10 loops, best of 3: 23.1 ms per loop</span>
</span></code></pre></td></tr></table></div></figure>


<p>My <code>numpy.show_config()</code> looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>lapack_opt_info:
</span><span class='line'>    libraries = ['mkl_rt', 'pthread']
</span><span class='line'>    library_dirs = ['/opt/intel/mkl/lib/intel64']
</span><span class='line'>    define_macros = [('SCIPY_MKL_H', None)]
</span><span class='line'>    include_dirs = ['/opt/intel/mkl/include']
</span><span class='line'>blas_opt_info:
</span><span class='line'>    libraries = ['mkl_rt', 'pthread']
</span><span class='line'>    library_dirs = ['/opt/intel/mkl/lib/intel64']
</span><span class='line'>    define_macros = [('SCIPY_MKL_H', None)]
</span><span class='line'>    include_dirs = ['/opt/intel/mkl/include']
</span><span class='line'>lapack_mkl_info:
</span><span class='line'>    libraries = ['mkl_rt', 'pthread']
</span><span class='line'>    library_dirs = ['/opt/intel/mkl/lib/intel64']
</span><span class='line'>    define_macros = [('SCIPY_MKL_H', None)]
</span><span class='line'>    include_dirs = ['/opt/intel/mkl/include']
</span><span class='line'>blas_mkl_info:
</span><span class='line'>    libraries = ['mkl_rt', 'pthread']
</span><span class='line'>    library_dirs = ['/opt/intel/mkl/lib/intel64']
</span><span class='line'>    define_macros = [('SCIPY_MKL_H', None)]
</span><span class='line'>    include_dirs = ['/opt/intel/mkl/include']
</span><span class='line'>mkl_info:
</span><span class='line'>    libraries = ['mkl_rt', 'pthread']
</span><span class='line'>    library_dirs = ['/opt/intel/mkl/lib/intel64']
</span><span class='line'>    define_macros = [('SCIPY_MKL_H', None)]
</span><span class='line'>    include_dirs = ['/opt/intel/mkl/include']</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
</feed>
